<html>
  <head>
    <meta charset="utf-8"/>
    <link rel="stylesheet" href="my.css">
  </head>
    <!-- go -->
    <body>
        <h1>WASM Experiments</h1>
        <h2>ðŸ‘‹ Open the developer tools ðŸ˜ƒ</h2>
        <h3></h3>
        <script> 
            // Load the wasm file
            let importObject = {
              wasi_snapshot_preview1: {
                fd_write: () => 0,
              }
            }

            WebAssembly.instantiateStreaming(fetch("main.wasm"), importObject) 
              .then(({ instance }) => {
                console.log("ðŸ“¦ Instance", instance)
                // ðŸ– Prepare the string argument (9)
                const stringParameter = "Bob Morane";
                const bytes = new TextEncoder("utf8").encode(stringParameter);
                
                // Copy argument to memory (10)
                // The TinyGo `malloc` is automatically exported
                const pos = instance.exports.malloc(bytes.length);
                const mem = new Uint8Array(
                  instance.exports.memory.buffer, pos, bytes.length
                )
                mem.set(bytes);
                
                // Call the helloWorld TinyGo function (11)
                // Get a kind of pair of values
                const helloWorldPosSize = instance.exports.helloWorld(pos, bytes.length);
                
                // Get pos and size of the result (12)
                const MASK = (2n ** 32n) - 1n;
                // Extract the values of the pair (using the mask)
                const stringPos = Number(helloWorldPosSize >> BigInt(32));
                const stringSize = Number(helloWorldPosSize & MASK);
                
                console.log("ðŸ¤– Position:", stringPos);
                console.log("ðŸ¤– Size:", stringSize);
                
                // helloWorldPosSize:
                //  pos                              size
                // 110101âº000000000000000000000000âº10110100
                //
                // [shift right] helloWorldPosSize >> 32b
                //  pos                              
                // 110101âº
                //
                // [& mask] helloWorldPosSize & mask
                //  mask âº111111111111111111111111âº11111111
                //  pos                              size
                //       âº000000000000000000000000âº10110100
                
                // Read the memory and (13)
                // "Extract" the buffer 
                const memory = instance.exports.memory;
                const completeBufferFromMemory = new Uint8Array(memory.buffer);
                const extractedBuffer = completeBufferFromMemory.slice(
                  stringPos, stringPos + stringSize
                );
                console.log("ðŸ¤– extractedBuffer:", extractedBuffer)
                
                // Display the string (14)
                // Decode the buffer (to string)
                const str = new TextDecoder("utf8").decode(extractedBuffer)
                console.log("ðŸŽ‰", str)
                document.querySelector("h3").innerHTML=str

              })
              .catch(error => {
                console.log("ðŸ˜¡ ouch", error)
              })
        </script>
  </body>
</html>
